image: registry.gitlab.com/epita-image/docker/cpp:latest

stages:
    - build
    - tests
    - doc
    - check

build:arch:
    stage: build
    before_script:
        - mkdir build
        - cd build
    script:
        - cmake -DCMAKE_BUILD_TYPE=RELEASE .. && make
    artifacts:
        paths:
            - build
        untracked: true

build:ubuntu:
    stage: build
    image: registry.gitlab.com/epita-image/docker/cpp-ubuntu/staging:master
    before_script:
        - mkdir build
        - cd build
    script:
        - cmake -DCMAKE_BUILD_TYPE=RELEASE .. && make

.unit-tests:
    stage: tests
    script:
        - ./build/tests/${module_name}/tests
    dependencies:
        - build:all

upload:doc:
    stage: doc
    dependencies:
        - build:arch
    script:
        - make doc -C build
        - mv doc/html/ public/
    artifacts:
        paths:
            - public

clang-tidy:all:
    stage: check
    script:
        - find src -name '*.cc' -exec clang-tidy -header-filter='.*' {} -- -Isrc -std=c++17 \;
